{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from '@iobroker/adapter-core';\nimport * as path from 'node:path';\nimport { GoodweRpc, type SensorMeta } from './lib/goodweRpc';\nimport { PythonEnv } from './lib/pythonEnv';\n\ntype Protocol = 'UDP' | 'TCP';\n\ninterface GoodweWeConfig extends ioBroker.AdapterConfig {\n    host: string;\n    pollInterval: number;\n    protocol: Protocol;\n    pythonCmd: string;\n    pythonArgs: string;\n    pythonPackages: string;\n    timeout: number;\n    retries: number;\n}\n\nclass GoodweWe extends utils.Adapter {\n    private rpc?: GoodweRpc;\n    private pollTimer?: ioBroker.Interval;\n    private sensorMeta = new Map<string, SensorMeta>();\n\n    public constructor(options: Partial<utils.AdapterOptions> = {}) {\n        super({ ...options, name: 'goodwe_we' });\n        this.on('ready', this.onReady.bind(this));\n        this.on('stateChange', this.onStateChange.bind(this));\n        this.on('unload', this.onUnload.bind(this));\n    }\n\n    private unitToRole(unit?: string): string | undefined {\n        switch (unit) {\n            case 'V':\n                return 'value.voltage';\n            case 'A':\n                return 'value.current';\n            case 'W':\n                return 'value.power';\n            case 'kWh':\n                return 'value.energy';\n            case 'Hz':\n                return 'value.frequency';\n            case '\u00B0C':\n                return 'value.temperature';\n            case '%':\n                return 'level';\n            default:\n                return undefined;\n        }\n    }\n\n    private async ensureBasics(): Promise<void> {\n        await this.setObjectNotExistsAsync('info', { type: 'channel', common: { name: 'Info' }, native: {} });\n        await this.setObjectNotExistsAsync('runtime', { type: 'channel', common: { name: 'Runtime' }, native: {} });\n        await this.setObjectNotExistsAsync('control', { type: 'channel', common: { name: 'Control' }, native: {} });\n\n        await this.setObjectNotExistsAsync('info.connection', {\n            type: 'state',\n            common: { name: 'Connected', type: 'boolean', role: 'indicator.connected', read: true, write: false },\n            native: {},\n        });\n\n        await this.setObjectNotExistsAsync('info.lastUpdate', {\n            type: 'state',\n            common: { name: 'Last update (ISO)', type: 'string', role: 'text', read: true, write: false },\n            native: {},\n        });\n\n        await this.setObjectNotExistsAsync('control.minSoc', {\n            type: 'state',\n            common: {\n                name: 'Reserve SOC (Min SOC)',\n                type: 'number',\n                role: 'level',\n                unit: '%',\n                min: 0,\n                max: 100,\n                read: true,\n                write: true,\n            },\n            native: {},\n        });\n    }\n\n    private async ensureRuntimeState(key: string, sampleValue: unknown): Promise<void> {\n        const id = `runtime.${key}`;\n        const meta = this.sensorMeta.get(key);\n\n        const type =\n            typeof sampleValue === 'number' ? 'number' : typeof sampleValue === 'boolean' ? 'boolean' : 'string';\n\n        await this.setObjectNotExistsAsync(id, {\n            type: 'state',\n            common: {\n                name: meta?.name ?? key,\n                type,\n                read: true,\n                write: false,\n                unit: meta?.unit,\n                role: meta?.unit\n                    ? (this.unitToRole(meta.unit) ?? (type === 'string' ? 'text' : 'value'))\n                    : type === 'string'\n                      ? 'text'\n                      : 'value',\n            },\n            native: {},\n        });\n    }\n\n    private async refreshMinSoc(): Promise<void> {\n        if (!this.rpc) {\n            return;\n        }\n        const soc = await this.rpc.getMinSoc();\n        await this.setStateAsync('control.minSoc', soc.min_soc, true);\n    }\n\n    private async pollOnce(): Promise<void> {\n        if (!this.rpc) {\n            return;\n        }\n\n        try {\n            const data = await this.rpc.readRuntime();\n\n            await this.setStateAsync('info.connection', true, true);\n            await this.setStateAsync('info.lastUpdate', new Date().toISOString(), true);\n\n            for (const [k, v] of Object.entries(data)) {\n                await this.ensureRuntimeState(k, v);\n\n                let stateVal: ioBroker.StateValue;\n                if (typeof v === 'number' || typeof v === 'string' || typeof v === 'boolean') {\n                    stateVal = v;\n                } else if (v === null || v === undefined) {\n                    stateVal = null;\n                } else {\n                    stateVal = JSON.stringify(v);\n                }\n\n                await this.setStateAsync(`runtime.${k}`, stateVal, true);\n            }\n        } catch (e: any) {\n            this.log.warn(`Poll failed: ${e?.message ?? e}`);\n            await this.setStateAsync('info.connection', false, true);\n        }\n    }\n\n    private async onReady(): Promise<void> {\n        await this.ensureBasics();\n\n        const cfg = this.config as unknown as GoodweWeConfig;\n\n        const host = String(cfg.host || '');\n        if (!host) {\n            this.log.error('No host configured.');\n            await this.setStateAsync('info.connection', false, true);\n            return;\n        }\n\n        const protocol = String(cfg.protocol || 'UDP').toUpperCase() as Protocol;\n        const pollSec = Number(cfg.pollInterval || 10);\n        const timeout = Number(cfg.timeout || 5);\n        const retries = Number(cfg.retries || 20);\n\n        const pythonCmd = String(cfg.pythonCmd || (process.platform === 'win32' ? 'py' : 'python3'));\n        const pythonArgs = String(cfg.pythonArgs || (process.platform === 'win32' ? '-3' : ''));\n        const pythonPackages = String(cfg.pythonPackages || 'goodwe>=0.4.8,<1.0');\n\n        const dataDir = utils.getAbsoluteInstanceDataDir(this);\n        const venvPython = await PythonEnv.ensureVenv(dataDir, { pythonCmd, pythonArgs, pythonPackages }, s =>\n            this.log.info(s),\n        );\n\n        const scriptPath = path.join(__dirname, '..', 'python', 'goodwe_rpc.py');\n\n        this.rpc = new GoodweRpc(venvPython, scriptPath, [\n            '--host',\n            host,\n            '--protocol',\n            protocol,\n            '--timeout',\n            String(timeout),\n            '--retries',\n            String(retries),\n        ]);\n        this.rpc.start();\n\n        try {\n            const sensors = await this.rpc.getSensors();\n            for (const s of sensors) {\n                this.sensorMeta.set(s.id, s);\n            }\n        } catch (e: any) {\n            this.log.warn(`getSensors failed (continuing without meta): ${e?.message ?? e}`);\n        }\n\n        this.subscribeStates('control.*');\n\n        await this.refreshMinSoc();\n        await this.pollOnce();\n\n        this.pollTimer = this.setInterval(async () => {\n            await this.pollOnce();\n        }, pollSec * 1000);\n    }\n\n    private async onStateChange(id: string, state: ioBroker.State | null | undefined): Promise<void> {\n        if (!state || state.ack) {\n            return;\n        }\n        if (!this.rpc) {\n            return;\n        }\n\n        const rel = id.replace(`${this.namespace}.`, '');\n        if (rel !== 'control.minSoc') {\n            return;\n        }\n\n        try {\n            const minSoc = Math.max(0, Math.min(100, Number(state.val)));\n            await this.rpc.setMinSoc(minSoc);\n            await this.refreshMinSoc();\n            await this.pollOnce();\n        } catch (e: any) {\n            this.log.warn(`setMinSoc failed: ${e?.message ?? e}`);\n            await this.refreshMinSoc();\n        }\n    }\n\n    private onUnload(callback: () => void): void {\n        try {\n            if (this.pollTimer) {\n                this.clearInterval(this.pollTimer);\n            }\n            this.rpc?.stop();\n            callback();\n        } catch {\n            callback();\n        }\n    }\n}\n\nif (require.main !== module) {\n    module.exports = (options: Partial<utils.AdapterOptions> | undefined) => new GoodweWe(options);\n} else {\n    (() => new GoodweWe())();\n}\n"],
  "mappings": "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",
  "names": []
}
