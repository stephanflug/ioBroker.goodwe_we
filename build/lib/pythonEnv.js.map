{
  "version": 3,
  "sources": ["../../src/lib/pythonEnv.ts"],
  "sourcesContent": ["\uFEFFimport { execFile } from 'node:child_process';\nimport { promises as fs } from 'node:fs';\nimport * as path from 'node:path';\nimport { promisify } from 'node:util';\n\nconst execFileAsync = promisify(execFile);\n\nasync function exists(p: string): Promise<boolean> {\n    try {\n        await fs.access(p);\n        return true;\n    } catch {\n        return false;\n    }\n}\n\nfunction splitArgs(argLine: string): string[] {\n    return argLine.trim() ? argLine.trim().split(/\\s+/) : [];\n}\n\nexport interface PythonEnvConfig {\n    pythonCmd: string;\n    pythonArgs: string;\n    pythonPackages: string;\n}\n\nexport class PythonEnv {\n    /**\n     * @param dataDir Adapter instance data directory.\n     * @param cfg Python environment configuration.\n     * @param log Logger callback.\n     */\n    public static async ensureVenv(dataDir: string, cfg: PythonEnvConfig, log: (s: string) => void): Promise<string> {\n        const venvDir = path.join(dataDir, 'pyenv');\n        const marker = path.join(venvDir, '.iobroker_goodwe_we_installed.json');\n\n        const baseArgs = splitArgs(cfg.pythonArgs);\n        const packages = cfg.pythonPackages.trim().split(/\\s+/).filter(Boolean);\n\n        await fs.mkdir(venvDir, { recursive: true });\n\n        const venvPython =\n            process.platform === 'win32'\n                ? path.join(venvDir, 'Scripts', 'python.exe')\n                : path.join(venvDir, 'bin', 'python');\n\n        const needCreate = !(await exists(path.join(venvDir, 'pyvenv.cfg'))) || !(await exists(venvPython));\n        if (needCreate) {\n            log(`Creating venv in ${venvDir} ...`);\n            await execFileAsync(cfg.pythonCmd, [...baseArgs, '-m', 'venv', venvDir], { timeout: 10 * 60_000 });\n        }\n\n        let installRequired = true;\n        if (await exists(marker)) {\n            try {\n                const old = JSON.parse(await fs.readFile(marker, 'utf-8')) as {\n                    pythonPackages?: string;\n                };\n                if (old?.pythonPackages === cfg.pythonPackages) {\n                    installRequired = false;\n                }\n            } catch {\n                // If marker cannot be parsed, re-install packages\n            }\n        }\n\n        if (installRequired) {\n            log('Installing Python packages in venv ...');\n            await execFileAsync(venvPython, ['-m', 'pip', 'install', '--upgrade', 'pip'], { timeout: 10 * 60_000 });\n            await execFileAsync(venvPython, ['-m', 'pip', 'install', '--upgrade', ...packages], {\n                timeout: 10 * 60_000,\n            });\n\n            await fs.writeFile(\n                marker,\n                JSON.stringify({ pythonPackages: cfg.pythonPackages, ts: new Date().toISOString() }, null, 2),\n            );\n        }\n\n        return venvPython;\n    }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAC,gCAAyB;AAC1B,qBAA+B;AAC/B,WAAsB;AACtB,uBAA0B;AAE1B,MAAM,oBAAgB,4BAAU,kCAAQ;AAExC,eAAe,OAAO,GAA6B;AAC/C,MAAI;AACA,UAAM,eAAAA,SAAG,OAAO,CAAC;AACjB,WAAO;AAAA,EACX,QAAQ;AACJ,WAAO;AAAA,EACX;AACJ;AAEA,SAAS,UAAU,SAA2B;AAC1C,SAAO,QAAQ,KAAK,IAAI,QAAQ,KAAK,EAAE,MAAM,KAAK,IAAI,CAAC;AAC3D;AAQO,MAAM,UAAU;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMnB,aAAoB,WAAW,SAAiB,KAAsB,KAA2C;AAC7G,UAAM,UAAU,KAAK,KAAK,SAAS,OAAO;AAC1C,UAAM,SAAS,KAAK,KAAK,SAAS,oCAAoC;AAEtE,UAAM,WAAW,UAAU,IAAI,UAAU;AACzC,UAAM,WAAW,IAAI,eAAe,KAAK,EAAE,MAAM,KAAK,EAAE,OAAO,OAAO;AAEtE,UAAM,eAAAA,SAAG,MAAM,SAAS,EAAE,WAAW,KAAK,CAAC;AAE3C,UAAM,aACF,QAAQ,aAAa,UACf,KAAK,KAAK,SAAS,WAAW,YAAY,IAC1C,KAAK,KAAK,SAAS,OAAO,QAAQ;AAE5C,UAAM,aAAa,CAAE,MAAM,OAAO,KAAK,KAAK,SAAS,YAAY,CAAC,KAAM,CAAE,MAAM,OAAO,UAAU;AACjG,QAAI,YAAY;AACZ,UAAI,oBAAoB,OAAO,MAAM;AACrC,YAAM,cAAc,IAAI,WAAW,CAAC,GAAG,UAAU,MAAM,QAAQ,OAAO,GAAG,EAAE,SAAS,KAAK,IAAO,CAAC;AAAA,IACrG;AAEA,QAAI,kBAAkB;AACtB,QAAI,MAAM,OAAO,MAAM,GAAG;AACtB,UAAI;AACA,cAAM,MAAM,KAAK,MAAM,MAAM,eAAAA,SAAG,SAAS,QAAQ,OAAO,CAAC;AAGzD,aAAI,2BAAK,oBAAmB,IAAI,gBAAgB;AAC5C,4BAAkB;AAAA,QACtB;AAAA,MACJ,QAAQ;AAAA,MAER;AAAA,IACJ;AAEA,QAAI,iBAAiB;AACjB,UAAI,wCAAwC;AAC5C,YAAM,cAAc,YAAY,CAAC,MAAM,OAAO,WAAW,aAAa,KAAK,GAAG,EAAE,SAAS,KAAK,IAAO,CAAC;AACtG,YAAM,cAAc,YAAY,CAAC,MAAM,OAAO,WAAW,aAAa,GAAG,QAAQ,GAAG;AAAA,QAChF,SAAS,KAAK;AAAA,MAClB,CAAC;AAED,YAAM,eAAAA,SAAG;AAAA,QACL;AAAA,QACA,KAAK,UAAU,EAAE,gBAAgB,IAAI,gBAAgB,KAAI,oBAAI,KAAK,GAAE,YAAY,EAAE,GAAG,MAAM,CAAC;AAAA,MAChG;AAAA,IACJ;AAEA,WAAO;AAAA,EACX;AACJ;",
  "names": ["fs"]
}
